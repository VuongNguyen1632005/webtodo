@model WebApplication1.Models.Bang

@{
    ViewBag.Title = Model.TenBang;
    var userRole = ViewBag.UserRole as string ?? "viewer";
    var canEdit = userRole == "owner" || userRole == "editor";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
    /* Container tràn màn hình và cuộn ngang */
    .board-container {
        display: flex;
        overflow-x: auto;
        height: calc(100vh - 100px);
        padding-bottom: 20px;
    }

    /* Cột */
    .board-column {
        min-width: 300px;
        max-width: 300px;
        background-color: #ebecf0;
        margin-right: 15px;
        border-radius: 5px;
        display: flex;
        flex-direction: column;
        max-height: 100%;
    }

    /* Header cột */
    .column-header {
        padding: 10px 15px;
        font-weight: bold;
        cursor: grab;
    }

    /* Danh sách thẻ (Cuộn dọc) */
    .card-list {
        padding: 0 10px 10px 10px;
        overflow-y: auto;
        flex-grow: 1;
        min-height: 50px;
    }

    /* Thẻ (Card) */
    .kanban-card {
        background-color: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 3px;
        box-shadow: 0 1px 0 rgba(9,30,66,.25);
        cursor: pointer;
        overflow-wrap: break-word;
        word-wrap: break-word;
        white-space: normal;
    }

        .kanban-card:hover {
            background-color: #f4f5f7;
        }

        /* Giới hạn dòng tiêu đề thẻ */
        .kanban-card .card-title {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    /* Style cho ô trống khi kéo thả */
    .ui-state-highlight {
        height: 40px;
        background-color: rgba(0,0,0,0.1);
        border: 1px dashed #ccc;
        margin-bottom: 10px;
    }

    .column-placeholder {
        background-color: rgba(0,0,0,0.1);
        border: 2px dashed #ccc;
        min-width: 300px;
        margin-right: 15px;
        border-radius: 5px;
    }

    .small {
        font-size: 12px;
    }

    .member-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    .member-item:last-child {
        border-bottom: none;
    }

    .member-info {
        flex-grow: 1;
    }

    .member-actions {
        display: flex;
        gap: 5px;
        align-items: center;
    }
</style>

<div class="container-fluid mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <h3 class="text-white" style="text-shadow: 1px 1px 2px #000;">@Model.TenBang</h3>
        <div>
            @if (userRole == "owner")
            {
                <button class="btn btn-info" data-toggle="modal" data-target="#shareModal">
                    <i class="fa fa-share-alt"></i> Chia sẻ
                </button>
            }
            @if (userRole != "owner")
            {
                <span class="badge badge-light" style="font-size: 14px;">
                    @(userRole == "editor" ? "Có thể sửa" : "Chỉ xem")
                </span>
            }
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="board-container">

        @if (Model.Cots != null)
        {
            foreach (var cot in Model.Cots.OrderBy(c => c.ThuTu))
            {
                <div class="board-column" data-column-id="@cot.MaCot">
                    <div class="column-header">
                        @cot.TenCot <span class="badge badge-secondary float-right">@cot.Thes.Count</span>
                    </div>

                    <div class="card-list" id="col-@cot.MaCot">
                        @if (cot.Thes != null)
                        {
                            foreach (var the in cot.Thes.OrderBy(t => t.ThuTu))
                            {
                                <div class="kanban-card" id="card_@the.MaThe" data-id="@the.MaThe">
                                    <div class="d-flex">
                                        <div class="me-2 pt-1" style="margin-right: 10px;">
                                            <input type="checkbox" class="card-checkbox stop-prop" data-id="@the.MaThe"
                                                   @(the.DaHoanThanh.GetValueOrDefault() ? "checked" : "")
                                                   @(!canEdit ? "disabled" : "")
                                                   style="cursor: pointer; width: 18px; height: 18px;">
                                        </div>

                                        <div class="flex-grow-1">
                                            <div class="card-title font-weight-bold mb-1" style="@(the.DaHoanThanh.GetValueOrDefault() ? "text-decoration: line-through; color: #888;" : "")">
                                                @the.TieuDe
                                            </div>

                                            <div class="card-infos d-flex align-items-center mt-1" style="gap: 10px;">
                                                @if (!string.IsNullOrEmpty(the.MoTa))
                                                {
                                                    <div class="card-desc-icon small text-muted" title="Có mô tả">
                                                        <i class="fa fa-align-left"></i>
                                                    </div>
                                                }

                                                @if (the.HanChot != null)
                                                {
                                                    var deadlineClass = (the.HanChot < DateTime.Now && !the.DaHoanThanh.GetValueOrDefault()) ? "text-danger font-weight-bold" : "text-muted";
                                                    if (the.DaHoanThanh.GetValueOrDefault()) { deadlineClass = "text-success"; }

                                                    <div class="card-deadline small" title="Hạn chót">
                                                        <i class="fa fa-clock-o"></i>
                                                        <span class="@deadlineClass">
                                                            @the.HanChot.Value.ToString("dd/MM")
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    @if (canEdit)
                    {
                        <div class="p-2 text-center text-muted add-card-btn" data-column-id="@cot.MaCot" style="cursor:pointer; border-top: 1px solid #ddd;">
                            + Thêm thẻ khác
                        </div>
                    }
                </div>
            }
        }

        @if (canEdit)
        {
            <div class="board-column" id="btnAddColumn" style="background: rgba(255,255,255,0.2); color: white; justify-content: center; align-items: center; min-height: 50px; height: 50px; cursor: pointer;">
                + Thêm danh sách khác
            </div>
        }

    </div>
</div>

<!-- Modal Chi tiết thẻ -->
<div class="modal fade" id="cardModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: none;">
                <input type="text" id="modalCardTitle" class="form-control font-weight-bold" style="font-size: 1.5rem; border: none; background: transparent;" placeholder="Tên thẻ..." @(!canEdit ? "readonly" : "")>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalCardId">

                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label class="font-weight-bold">Mô tả</label>
                            <textarea id="modalCardDesc" class="form-control" rows="5" placeholder="Thêm mô tả chi tiết..." @(!canEdit ? "readonly" : "")></textarea>
                        </div>

                        <div class="form-group mt-3">
                            <label class="font-weight-bold">📅 Hạn chót (Deadline)</label>
                            <input type="date" id="modalCardDeadline" class="form-control" @(!canEdit ? "readonly" : "")>
                        </div>

                        @if (canEdit)
                        {
                            <button type="button" class="btn btn-success mt-2" id="btnSaveCard">Lưu thay đổi</button>
                        }
                    </div>

                    <div class="col-md-4">
                        @if (canEdit)
                        {
                            <label class="font-weight-bold">Thao tác</label>
                            <button class="btn btn-danger btn-block" id="btnDeleteCard">Xóa thẻ</button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chia sẻ bảng -->
<div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chia sẻ bảng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email người dùng</label>
                    <input type="email" id="shareEmail" class="form-control" placeholder="example@email.com">
                </div>
                <div class="form-group">
                    <label>Quyền</label>
                    <select id="shareRole" class="form-control">
                        <option value="viewer">Chỉ xem</option>
                        <option value="editor">Có thể sửa</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" id="btnShare">Mời</button>
                
                <hr>
                <h6>Thành viên hiện tại</h6>
                <div id="memberList"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script>
        var canEdit = @(canEdit ? "true" : "false");
        var maBang = @Model.MaBang;
        
        $("body").css("background-color", "@Model.MauNen");

        $(document).ready(function () {

            // 1. KÉO THẢ THẺ (Cards) - Chỉ cho phép nếu có quyền sửa
            if (canEdit) {
                $(".card-list").sortable({
                    connectWith: ".card-list",
                    placeholder: "ui-state-highlight",
                    items: ".kanban-card",
                    stop: function (event, ui) {
                        var item = ui.item;
                        var cardId = item.attr("data-id");
                        var newColumn = item.closest(".card-list");
                        var newColumnId = newColumn.attr("id").replace("col-", "");
                        var sortedIds = newColumn.sortable("toArray", { attribute: "data-id" });

                        $.ajax({
                            url: '/Board/MoveCard',
                            type: 'POST',
                            traditional: true,
                            data: { maThe: cardId, maCotMoi: newColumnId, cardIds: sortedIds }
                        });
                    }
                }).disableSelection();
            }

            // 2. THÊM THẺ MỚI
            $(".add-card-btn").click(function () {
                if (!canEdit) return;
                var columnId = $(this).data("column-id");
                var title = prompt("Nhập nội dung công việc:");
                if (title) {
                    $.post('/Board/CreateCard', { maCot: columnId, noiDung: title }, function(res) {
                         if (res.success) location.reload();
                    });
                }
            });

            // 3. XỬ LÝ CHECKBOX (Fix lỗi click không ăn)
            // Chặn sự kiện click lan ra thẻ cha
            $(document).on("click", ".stop-prop", function(e) {
                e.stopPropagation();
            });

            // Gửi trạng thái khi check
            $(document).on("change", ".card-checkbox", function() {
                if (!canEdit) return;
                var cardId = $(this).data("id");
                var isChecked = $(this).is(":checked");
                var cardTitle = $(this).closest(".kanban-card").find(".card-title");
                var deadlineSpan = $(this).closest(".kanban-card").find(".card-deadline span");

                if (isChecked) {
                    cardTitle.css({ "text-decoration": "line-through", "color": "#888" });
                    deadlineSpan.removeClass("text-danger font-weight-bold").addClass("text-success");
                } else {
                    cardTitle.css({ "text-decoration": "none", "color": "" });
                    deadlineSpan.removeClass("text-success").addClass("text-muted");
                }

                $.post("/Board/UpdateCardCompletion", { id: cardId, status: isChecked });
            });

            // 4. CLICK VÀO THẺ ĐỂ SỬA (MODAL)
            $(document).on("click", ".kanban-card", function () {
                var cardId = $(this).data("id");
                $.get("/Board/GetCardDetails/" + cardId, function (data) {
                    if (data && data.success) {
                        $("#modalCardId").val(data.id);
                        $("#modalCardTitle").val(data.title);
                        $("#modalCardDesc").val(data.desc);
                        $("#modalCardDeadline").val(data.deadline);
                        $("#cardModal").modal("show");
                    }
                });
            });

            // 5. Nút Lưu
            $("#btnSaveCard").click(function () {
                if (!canEdit) return;
                var id = $("#modalCardId").val();
                var title = $("#modalCardTitle").val();
                var desc = $("#modalCardDesc").val();
                var deadline = $("#modalCardDeadline").val();

                $.post("/Board/UpdateCardDetails", { id: id, title: title, desc: desc, deadline: deadline }, function (res) {
                    if (res.success) location.reload(); // Reload để cập nhật lại toàn bộ UI cho chuẩn
                });
            });

            // 6. Nút Xóa
            $("#btnDeleteCard").click(function () {
                if (!canEdit) return;
                if (confirm("Xóa thẻ này?")) {
                    var id = $("#modalCardId").val();
                    $.post("/Board/DeleteCard", { id: id }, function (res) {
                        if (res.success) {
                            $("#card_" + id).remove();
                            $("#cardModal").modal("hide");
                        }
                    });
                }
            });

            // 7. THÊM CỘT MỚI
            $("#btnAddColumn").click(function () {
                if (!canEdit) return;
                var name = prompt("Nhập tên danh sách mới:");
                if (name) {
                    $.post("/Board/CreateColumn", { maBang: maBang, tenCot: name }, function (res) {
                        if (res.success) location.reload();
                    });
                }
            });

            // 8. KÉO THẢ CỘT - Chỉ cho phép nếu có quyền sửa
            if (canEdit) {
                $(".board-container").sortable({
                    items: ".board-column:not(#btnAddColumn)",
                    placeholder: "column-placeholder",
                    tolerance: "pointer",
                    axis: "x",
                    start: function(e, ui){ ui.placeholder.height(ui.item.outerHeight()); },
                    stop: function (event, ui) {
                        var sortedIds = $(this).sortable("toArray", { attribute: "data-column-id" });
                        $.ajax({
                            url: '/Board/UpdateColumnPosition',
                            type: 'POST',
                            traditional: true,
                            data: { columnIds: sortedIds }
                        });
                    }
                });
            }

            // === CHỨC NĂNG CHIA SẺ ===

            // Mời thành viên
            $('#btnShare').click(function() {
                var email = $('#shareEmail').val();
                var vaiTro = $('#shareRole').val();
                
                if (!email) {
                    alert('Vui lòng nhập email');
                    return;
                }
                
                $.post('/Board/ShareBoard', {
                    maBang: maBang,
                    email: email,
                    vaiTro: vaiTro
                }, function(result) {
                    if (result.success) {
                        alert('Đã mời thành công!');
                        loadMembers();
                        $('#shareEmail').val('');
                    } else {
                        alert(result.message);
                    }
                });
            });

            // Load danh sách thành viên
            function loadMembers() {
                $.get('/Board/GetBoardMembers', { maBang: maBang }, function(members) {
                    var html = '';
                    members.forEach(function(m) {
                        var roleText = m.vaiTro == 'owner' ? 'Chủ sở hữu' : 
                                      (m.vaiTro == 'editor' ? 'Có thể sửa' : 'Chỉ xem');
                        var badgeClass = m.vaiTro == 'owner' ? 'badge-primary' : 
                                        (m.vaiTro == 'editor' ? 'badge-success' : 'badge-secondary');
                        
                        html += '<div class="member-item">';
                        html += '<div class="member-info">';
                        html += '<strong>' + m.hoTen + '</strong><br>';
                        html += '<small class="text-muted">' + m.email + '</small>';
                        html += '</div>';
                        html += '<div class="member-actions">';
                        
                        if (m.vaiTro != 'owner') {
                            html += '<select class="form-control form-control-sm role-select" data-id="' + m.maTaiKhoan + '" style="width: auto;">';
                            html += '<option value="viewer"' + (m.vaiTro == 'viewer' ? ' selected' : '') + '>Chỉ xem</option>';
                            html += '<option value="editor"' + (m.vaiTro == 'editor' ? ' selected' : '') + '>Có thể sửa</option>';
                            html += '</select>';
                            html += '<button class="btn btn-sm btn-danger btn-remove-member" data-id="' + m.maTaiKhoan + '"><i class="fa fa-times"></i></button>';
                        } else {
                            html += '<span class="badge ' + badgeClass + '">' + roleText + '</span>';
                        }
                        
                        html += '</div>';
                        html += '</div>';
                    });
                    $('#memberList').html(html);
                });
            }

            // Xóa thành viên
            $(document).on('click', '.btn-remove-member', function() {
                var maTaiKhoan = $(this).data('id');
                if (confirm('Bạn có chắc muốn xóa thành viên này?')) {
                    $.post('/Board/RemoveMember', {
                        maBang: maBang,
                        maTaiKhoan: maTaiKhoan
                    }, function(result) {
                        if (result.success) {
                            loadMembers();
                        }
                    });
                }
            });

            // Cập nhật vai trò
            $(document).on('change', '.role-select', function() {
                var maTaiKhoan = $(this).data('id');
                var vaiTroMoi = $(this).val();
                
                $.post('/Board/UpdateMemberRole', {
                    maBang: maBang,
                    maTaiKhoan: maTaiKhoan,
                    vaiTroMoi: vaiTroMoi
                }, function(result) {
                    if (!result.success) {
                        alert('Không thể cập nhật vai trò');
                        loadMembers();
                    }
                });
            });

            // Load members khi mở modal
            $('#shareModal').on('show.bs.modal', function() {
                loadMembers();
            });

        });
    </script>
}