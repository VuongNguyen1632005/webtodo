@model WebApplication1.Models.Bang

@{
    ViewBag.Title = Model.TenBang;
    var userRole = ViewBag.UserRole as string ?? "viewer";
    var canEdit = userRole == "owner" || userRole == "editor";
    var themeColor = Model.MauNen ?? "#026AA7";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
    /* CSS Kéo thả & Giao diện Board (GIỮ NGUYÊN) */
    .board-container {
        display: flex;
        overflow-x: auto;
        height: calc(100vh - 100px);
        padding-bottom: 20px;
    }

    .board-column {
        min-width: 300px;
        max-width: 300px;
        background-color: #ebecf0;
        margin-right: 15px;
        border-radius: 5px;
        display: flex;
        flex-direction: column;
        max-height: 100%;
    }

    .column-header {
        padding: 10px 15px;
        font-weight: bold;
        cursor: grab;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
    }

    /* Style cho tiêu đề bảng có thể edit */
    .board-title {
        color: white;
        text-shadow: 1px 1px 2px #000;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background 0.2s;
        display: inline-block;
        min-width: 200px;
    }

    .board-title:hover {
        background: rgba(255,255,255,0.2);
    }

    .board-title-input {
        background: rgba(255,255,255,0.9);
        border: 2px solid #0079bf;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 1.5rem;
        font-weight: bold;
        color: #172b4d;
        min-width: 200px;
        outline: none;
    }

    .card-list {
        padding: 0 10px 10px 10px;
        overflow-y: auto;
        flex-grow: 1;
        min-height: 50px;
    }

    .kanban-card {
        background-color: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 3px;
        box-shadow: 0 1px 0 rgba(9,30,66,.25);
        cursor: pointer;
        overflow-wrap: break-word;
        word-wrap: break-word;
        white-space: normal;
    }

        .kanban-card:hover {
            background-color: #f4f5f7;
        }

        .kanban-card .card-title {
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Giới hạn 3 dòng */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            /* Cho phép xuống dòng với từ dài, tránh tràn ra ngoài */
            word-break: break-word;
            overflow-wrap: anywhere;
            hyphens: auto;
            white-space: normal;
        }

    .ui-state-highlight {
        height: 40px;
        background-color: rgba(0,0,0,0.1);
        border: 1px dashed #ccc;
        margin-bottom: 10px;
    }

    .column-placeholder {
        background-color: rgba(0,0,0,0.1);
        border: 2px dashed #ccc;
        min-width: 300px;
        margin-right: 15px;
        border-radius: 5px;
    }

    .small {
        font-size: 12px;
    }

    /* CSS Nút chức năng kính mờ */
    .btn-glass {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(5px);
        padding: 8px 16px;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

        .btn-glass:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            text-decoration: none;
        }

    .btn-glass-danger:hover {
        background-color: rgba(220, 53, 69, 0.8);
        border-color: #dc3545;
    }

    .column-actions {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .column-badge {
        display: inline-block;
        background: #6c757d;
        color: #fff;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 12px;
        line-height: 20px;
    }

    .column-action-btn {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #6c757d;
        color: #fff;
        border-radius: 4px; /* hình vuông bo nhẹ giống badge */
        border: none;
        cursor: pointer;
        padding: 0;
    }

    /* Style cho comment section */
    .comment-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        position: relative;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: @themeColor;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 8px;
    }

    .comment-author {
        font-weight: 600;
        font-size: 14px;
    }

    .comment-time {
        font-size: 11px;
        color: #6c757d;
    }

    .comment-content {
        padding-left: 40px;
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;
    }

    .comment-delete {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .comment-item:hover .comment-delete {
        opacity: 1;
    }

    .no-comments {
        text-align: center;
        color: #6c757d;
        padding: 20px;
        font-style: italic;
    }

    .column-action-btn:hover { background: #dc3545; }

    /* CSS cho Labels */
    .card-labels {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-bottom: 6px;
    }

    .card-label {
        display: inline-block;
        height: 8px;
        min-width: 40px;
        border-radius: 4px;
    }

    .card-label-full {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        color: white;
        font-size: 12px;
        font-weight: 600;
    }

    /* CSS cho Card Members (avatars) */
    .card-members {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 6px;
    }

    .card-member-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #0079bf;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
    }

    /* CSS cho Modal Labels & Members */
    .modal-section {
        margin-bottom: 20px;
    }

    .modal-section-title {
        font-weight: 600;
        font-size: 14px;
        color: #5e6c84;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .label-list, .member-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
    }

    .label-item {
        padding: 6px 12px;
        border-radius: 4px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.1s;
    }

    .label-item:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .label-item.selected {
        box-shadow: inset 0 0 0 2px #172b4d;
    }

    .label-item .fa-check {
        margin-left: 6px;
    }

    .member-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.1s;
        border: 2px solid transparent;
    }

    .member-item:hover {
        background: #f0f0f0;
    }

    .member-item.selected {
        background: #e3f2fd;
        border-color: #0079bf;
    }

    .member-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #0079bf;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 13px;
    }

    .sidebar-section {
        background: #f4f5f7;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 12px;
    }

    .sidebar-section-title {
        font-size: 12px;
        font-weight: 600;
        color: #5e6c84;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .sidebar-btn {
        display: block;
        width: 100%;
        padding: 8px 12px;
        background: #091e420a;
        border: none;
        border-radius: 4px;
        text-align: left;
        cursor: pointer;
        margin-bottom: 6px;
        transition: background 0.1s;
    }

    .sidebar-btn:hover {
        background: #091e4214;
    }

    .sidebar-btn i {
        margin-right: 8px;
        width: 16px;
    }

    /* Color picker for labels */
    .color-picker {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.1s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: #172b4d;
    }
</style>

<div class="container-fluid mb-3">
    <div class="d-flex justify-content-between align-items-center">
        @if (canEdit)
        {
            <h3 id="boardTitleDisplay" class="board-title m-0">@Model.TenBang</h3>
            <input type="text" id="boardTitleInput" class="board-title-input" value="@Model.TenBang" style="display:none;" />
        }
        else
        {
            <h3 class="text-white m-0" style="text-shadow: 1px 1px 2px #000;">@Model.TenBang</h3>
        }
        <div>
            @if (userRole == "owner")
            {
                <a href="@Url.Action("Index", "Member", new { maBang = Model.MaBang })" class="btn-glass ml-2">
                    <i class="fa fa-users"></i> Quản lý thành viên
                </a>
            }

            @if (userRole != "owner")
            {
                <span class="badge badge-light mr-2" style="font-size: 14px; padding: 10px;">
                    @(userRole == "editor" ? "Bạn là: Editor" : "Bạn là: Viewer")
                </span>

                using (Html.BeginForm("Leave", "Member", FormMethod.Post, new { style = "display:inline;" }))
                {
                    <input type="hidden" name="maBang" value="@Model.MaBang" />
                    <button type="submit" class="btn-glass btn-glass-danger" style="border:none; cursor:pointer;" onclick="return confirm('Rời bảng?');">
                        <i class="fa fa-sign-out"></i> Rời bảng
                    </button>
                }
            }
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="board-container">
        @if (Model.Cots != null)
        {
            foreach (var cot in Model.Cots.OrderBy(c => c.ThuTu))
            {
                <div class="board-column" data-column-id="@cot.MaCot">
                    <div class="column-header">
                        <span>@cot.TenCot</span>
                        <span class="column-actions">
                            <span class="column-badge">@cot.Thes.Count</span>
                            @if (canEdit)
                            {
                                <button class="column-action-btn btn-delete-column" data-column-id="@cot.MaCot" title="Xóa danh sách"><i class="fa fa-trash"></i></button>
                            }
                        </span>
                    </div>

                    <div class="card-list" id="col-@cot.MaCot">
                        @if (cot.Thes != null)
                        {
                            foreach (var the in cot.Thes.OrderBy(t => t.ThuTu))
                            {
                                <div class="kanban-card" id="card_@the.MaThe" data-id="@the.MaThe">
                                    <!-- Labels hiển thị trên thẻ -->
                                    <div class="card-labels" id="cardLabels_@the.MaThe">
                                        @if (the.NhanCuaThes != null)
                                        {
                                            foreach (var nhan in the.NhanCuaThes)
                                            {
                                                <span class="card-label" style="background-color: @nhan.NhanCuaBang.MaMau;" title="@nhan.NhanCuaBang.TenHienThi"></span>
                                            }
                                        }
                                    </div>

                                    <div class="d-flex">
                                        <div class="me-2 pt-1" style="margin-right: 10px;">
                                            <input type="checkbox" class="card-checkbox stop-prop" data-id="@the.MaThe"
                                                   @(the.DaHoanThanh.GetValueOrDefault() ? "checked" : "")
                                                   @(!canEdit ? "disabled" : "")
                                                   style="cursor: pointer; width: 18px; height: 18px;">
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="card-title font-weight-bold mb-1" style="@(the.DaHoanThanh.GetValueOrDefault() ? "text-decoration: line-through; color: #888;" : "")">
                                                @the.TieuDe
                                            </div>
                                            <div class="card-infos d-flex align-items-center mt-1" style="gap: 10px;">
                                                @if (!string.IsNullOrEmpty(the.MoTa))
                                                {<div class="card-desc-icon small text-muted"><i class="fa fa-align-left"></i></div>}
                                                @if (the.HanChot != null)
                                                {
                                                    var deadlineClass = (the.HanChot < DateTime.Now && !the.DaHoanThanh.GetValueOrDefault()) ? "text-danger font-weight-bold" : "text-muted";
                                                    if (the.DaHoanThanh.GetValueOrDefault()) { deadlineClass = "text-success"; }
                                                    <div class="card-deadline small"><i class="fa fa-clock-o"></i> <span class="@deadlineClass">@the.HanChot.Value.ToString("dd/MM")</span></div>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Members hiển thị trên thẻ -->
                                    <div class="card-members" id="cardMembers_@the.MaThe">
                                        @if (the.ThanhVienCuaThes != null)
                                        {
                                            foreach (var tv in the.ThanhVienCuaThes)
                                            {
                                                var initials = !string.IsNullOrEmpty(tv.TaiKhoan.HoTen) 
                                                    ? string.Join("", tv.TaiKhoan.HoTen.Split(' ').Where(s => !string.IsNullOrEmpty(s)).Select(s => s[0])).ToUpper()
                                                    : tv.TaiKhoan.DiaChiEmail.Substring(0, 2).ToUpper();
                                                <span class="card-member-avatar" title="@(tv.TaiKhoan.HoTen ?? tv.TaiKhoan.DiaChiEmail)">@initials</span>
                                            }
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    @if (canEdit)
                    {
                        <div class="p-2 text-center text-muted add-card-btn" data-column-id="@cot.MaCot" style="cursor:pointer; border-top: 1px solid #ddd;">+ Thêm thẻ khác</div>
                    }
                </div>
            }
        }

        @if (canEdit)
        {
            <div class="board-column" id="btnAddColumn" style="background: rgba(255,255,255,0.2); color: white; justify-content: center; align-items: center; min-height: 50px; height: 50px; cursor: pointer;">+ Thêm danh sách khác</div>
        }
    </div>
</div>

<!-- Modal Chi tiết thẻ -->
<div class="modal fade" id="cardModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document" style="max-width: 800px;">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: none;">
                <input type="text" id="modalCardTitle" class="form-control font-weight-bold" style="font-size: 1.5rem; border: none; background: transparent;" placeholder="Tên thẻ..." @(!canEdit ? "readonly" : "")>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalCardId">
                <div class="row">
                    <!-- Cột trái: Nội dung chính -->
                    <div class="col-md-8">
                        <!-- Hiển thị Labels đã gán -->
                        <div class="modal-section">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="modal-section-title mb-0"><i class="fa fa-tags"></i> Nhãn</div>
                                @if (canEdit)
                                {
                                    <button class="btn btn-sm btn-outline-secondary" id="btnShowLabels">
                                        <i class="fa fa-plus"></i> Thêm
                                    </button>
                                }
                            </div>
                            <div id="modalCardLabels" class="label-list">
                                <!-- Labels sẽ được load bằng JS -->
                            </div>
                        </div>

                        <!-- Hiển thị Members đã gán -->
                        <div class="modal-section">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="modal-section-title mb-0"><i class="fa fa-users"></i> Thành viên</div>
                                @if (canEdit)
                                {
                                    <button class="btn btn-sm btn-outline-secondary" id="btnShowMembers">
                                        <i class="fa fa-plus"></i> Thêm
                                    </button>
                                }
                            </div>
                            <div id="modalCardMembers" class="d-flex flex-wrap" style="gap: 8px;">
                                <!-- Members sẽ được load bằng JS -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold"><i class="fa fa-align-left"></i> Mô tả</label>
                            <textarea id="modalCardDesc" class="form-control" rows="4" placeholder="Thêm mô tả chi tiết..." @(!canEdit ? "readonly" : "")></textarea>
                        </div>
                        <div class="form-group mt-3">
                            <label class="font-weight-bold"><i class="fa fa-calendar"></i> Hạn chót</label>
                            <input type="date" id="modalCardDeadline" class="form-control" @(!canEdit ? "readonly" : "")>
                        </div>
                        @if (canEdit)
                        {
                            <div class="mt-3">
                                <button type="button" class="btn btn-success" id="btnSaveCard">
                                    <i class="fa fa-save"></i> Lưu thay đổi
                                </button>
                                <button class="btn btn-danger" id="btnDeleteCard">
                                    <i class="fa fa-trash"></i> Xóa thẻ
                                </button>
                            </div>
                        }
                    </div>

                    <!-- Cột phải: Nhận xét -->
                    <div class="col-md-4" style="border-left: 1px solid #e0e0e0;">
                        <div class="comment-section">
                            <h5 class="font-weight-bold mb-3">
                                <i class="fa fa-comments"></i> Nhận xét
                            </h5>
                            
                            <!-- Form nhập comment -->
                            <div class="mb-3">
                                <textarea id="commentInput" class="form-control" rows="3" placeholder="Viết bình luận..."></textarea>
                                <button type="button" class="btn btn-primary btn-sm mt-2" id="btnAddComment">
                                    <i class="fa fa-paper-plane"></i> Gửi
                                </button>
                            </div>

                            <!-- Danh sách comment -->
                            <div id="commentsList" style="max-height: 300px; overflow-y: auto;">
                                <!-- Comments sẽ được load bằng JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chọn Labels -->
<div class="modal fade" id="labelsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nhãn</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div id="labelsList" class="label-list" style="flex-direction: column;">
                    <!-- Labels sẽ được load bằng JS -->
                </div>
                <hr>
                <div class="font-weight-bold mb-2">Tạo nhãn mới</div>
                <input type="text" id="newLabelName" class="form-control mb-2" placeholder="Tên nhãn...">
                <div class="color-picker" id="colorPicker">
                    <div class="color-option selected" data-color="#61bd4f" style="background: #61bd4f;"></div>
                    <div class="color-option" data-color="#f2d600" style="background: #f2d600;"></div>
                    <div class="color-option" data-color="#ff9f1a" style="background: #ff9f1a;"></div>
                    <div class="color-option" data-color="#eb5a46" style="background: #eb5a46;"></div>
                    <div class="color-option" data-color="#c377e0" style="background: #c377e0;"></div>
                    <div class="color-option" data-color="#0079bf" style="background: #0079bf;"></div>
                    <div class="color-option" data-color="#00c2e0" style="background: #00c2e0;"></div>
                    <div class="color-option" data-color="#51e898" style="background: #51e898;"></div>
                    <div class="color-option" data-color="#ff78cb" style="background: #ff78cb;"></div>
                    <div class="color-option" data-color="#344563" style="background: #344563;"></div>
                </div>
                <button class="btn btn-primary btn-sm mt-3" id="btnCreateLabel">
                    <i class="fa fa-plus"></i> Tạo nhãn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chọn Members -->
<div class="modal fade" id="membersModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thành viên</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div id="membersList">
                    <!-- Members sẽ được load bằng JS -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script>
        // CÁC BIẾN JS CẦN THIẾT
        var canEdit = @Html.Raw(Json.Encode(canEdit));
        var maBang = @Html.Raw(Json.Encode(Model.MaBang));
        var themeColor = @Html.Raw(Json.Encode(themeColor));

        $("body").css("background-color", themeColor);

        $(document).ready(function () {

            // 0. ĐỔI TÊN BẢNG (chỉ cho owner/editor)
            if (canEdit) {
                $("#boardTitleDisplay").click(function(){
                    $(this).hide();
                    $("#boardTitleInput").show().focus().select();
                });

                $("#boardTitleInput").on('blur keypress', function(e){
                    if (e.type === 'blur' || (e.type === 'keypress' && e.which === 13)) {
                        e.preventDefault();
                        var newName = $(this).val().trim();
                        
                        if (!newName) {
                            alert("Tên bảng không được rỗng!");
                            $(this).val($("#boardTitleDisplay").text().trim());
                            return;
                        }

                        // Gọi API đổi tên
                        $.post('/Board/UpdateBoardName', { maBang: maBang, tenMoi: newName })
                            .done(function(response){
                                if (response && response.success) {
                                    $("#boardTitleDisplay").text(response.tenMoi);
                                    $("#boardTitleInput").val(response.tenMoi).hide();
                                    $("#boardTitleDisplay").show();
                                    document.title = response.tenMoi; // Cập nhật title trang
                                } else {
                                    alert(response.message || "Không thể đổi tên bảng");
                                }
                            })
                            .fail(function(){
                                alert("Lỗi khi đổi tên bảng");
                            });
                    }
                });

                $("#boardTitleInput").keyup(function(e){
                    if (e.which === 27) { // ESC
                        $(this).val($("#boardTitleDisplay").text().trim()).hide();
                        $("#boardTitleDisplay").show();
                    }
                });
            }

            // Helper: Cập nhật badge số thẻ của cột
            function updateColumnBadge(columnId) {
                var count = $("#col-" + columnId + " .kanban-card").length;
                $('[data-column-id="' + columnId + '"] .column-badge').text(count);
            }

            // 1. KÉO THẢ THẺ
            if (canEdit) {
                $(".card-list").sortable({
                    connectWith: ".card-list", placeholder: "ui-state-highlight", items: ".kanban-card",
                    stop: function (event, ui) {
                        var item = ui.item;
                        var newColumnId = item.closest(".card-list").attr("id").replace("col-", "");
                        var sortedIds = item.closest(".card-list").sortable("toArray", { attribute: "data-id" });
                        
                        // Cập nhật badge cột nguồn và cột đích
                        var oldColumnId = $(event.target).attr("id").replace("col-", "");
                        updateColumnBadge(oldColumnId);
                        updateColumnBadge(newColumnId);
                        
                        $.ajax({
                            url: '/Board/MoveCard', type: 'POST', traditional: true,
                            data: { maThe: item.attr("data-id"), maCotMoi: newColumnId, cardIds: sortedIds }
                        });
                    }
                }).disableSelection();

                $(".board-container").sortable({
                    items: ".board-column:not(#btnAddColumn)", placeholder: "column-placeholder", tolerance: "pointer", axis: "x",
                    start: function(e, ui){ ui.placeholder.height(ui.item.outerHeight()); },
                    stop: function (event, ui) {
                        var sortedIds = $(this).sortable("toArray", { attribute: "data-column-id" });
                        $.ajax({ url: '/Board/UpdateColumnPosition', type: 'POST', traditional: true, data: { columnIds: sortedIds } });
                    },
                    cancel: ".btn-delete-column"
                });
            }

            // Ngăn việc bắt sự kiện kéo khi click nút xóa
            $(document).on('mousedown', '.btn-delete-column', function(e){ e.stopPropagation(); });
            $(document).on('click', '.btn-delete-column', function(e){
                e.preventDefault();
                e.stopPropagation();
                if (!canEdit) return;
                var colId = $(this).data('column-id');
                if (confirm('Xóa danh sách này cùng tất cả thẻ bên trong?')) {
                    $.post('/Board/DeleteColumn', { maCot: colId })
                        .done(function(r){
                            if (r && r.success) {
                                $('[data-column-id="' + colId + '"]').remove();
                            } else {
                                alert(r.message || 'Không thể xóa danh sách');
                            }
                        })
                        .fail(function(xhr){
                            alert('Lỗi xóa danh sách: ' + (xhr.responseText || 'Unknown'));
                        });
                }
            });

            // 2. THÊM THẺ MỚI
            $(".add-card-btn").click(function () {
                if (!canEdit) return;
                var colId = $(this).data("column-id");
                var title = prompt("Nhập nội dung:");
                if (title) {
                    $.post('/Board/CreateCard', { maCot: colId, noiDung: title }, function(r) { 
                        if(r.success) {
                            location.reload(); // Reload để hiện thẻ mới và cập nhật badge
                        }
                    });
                }
            });

            // 3. THÊM CỘT MỚI
            $("#btnAddColumn").click(function () {
                if (!canEdit) return;
                var name = prompt("Tên danh sách:");
                if (name) $.post("/Board/CreateColumn", { maBang: maBang, tenCot: name }, function(r) { if(r.success) location.reload(); });
            });

            // 4. CHECKBOX
            $(document).on("click", ".stop-prop", function(e) { e.stopPropagation(); });
            $(document).on("change", ".card-checkbox", function() {
                if (!canEdit) return;
                var isChecked = $(this).is(":checked");
                var card = $(this).closest(".kanban-card");
                if (isChecked) {
                    card.find(".card-title").css({ "text-decoration": "line-through", "color": "#888" });
                    card.find(".card-deadline span").removeClass("text-danger").addClass("text-success");
                } else {
                    card.find(".card-title").css({ "text-decoration": "none", "color": "" });
                    card.find(".card-deadline span").removeClass("text-success").addClass("text-muted");
                }
                $.post("/Board/UpdateCardCompletion", { id: $(this).data("id"), status: isChecked });
            });

            // 5. CHI TIẾT THẺ (MODAL)
            $(document).on("click", ".kanban-card", function () {
                var id = $(this).data("id");
                $.get("/Board/GetCardDetails/" + id, function (data) {
                    if (data && data.success) {
                        $("#modalCardId").val(data.id); 
                        $("#modalCardTitle").val(data.title);
                        $("#modalCardDesc").val(data.desc); 
                        $("#modalCardDeadline").val(data.deadline);
                        $("#commentInput").val("");
                        loadComments(data.id);
                        loadCardLabels(data.id);
                        loadCardMembers(data.id);
                        $("#cardModal").modal("show");
                    }
                });
            });

            // ========== LABELS FUNCTIONS =========
            
            // Load labels của thẻ hiện tại
            function loadCardLabels(cardId) {
                $.get("/Board/GetCardLabels?maThe=" + cardId, function(response) {
                    if (response && response.success) {
                        var html = '';
                        if (response.labels && response.labels.length > 0) {
                            response.labels.forEach(function(label) {
                                html += '<span class="card-label-full" style="background-color: ' + label.maMau + ';">' + escapeHtml(label.tenHienThi) + '</span>';
                            });
                        } else {
                            html = '<span class="text-muted small">Chưa có nhãn</span>';
                        }
                        $("#modalCardLabels").html(html);
                    }
                });
            }

            // Mở modal chọn labels
            $("#btnShowLabels").click(function() {
                var cardId = $("#modalCardId").val();
                loadLabelsModal(cardId);
                $("#labelsModal").modal("show");
            });

            // Load danh sách labels cho modal
            function loadLabelsModal(cardId) {
                // Lấy labels của board
                $.get("/Board/GetBoardLabels?maBang=" + maBang, function(boardLabels) {
                    // Lấy labels đã gán cho thẻ
                    $.get("/Board/GetCardLabels?maThe=" + cardId, function(cardLabels) {
                        var assignedIds = [];
                        if (cardLabels.success && cardLabels.labels) {
                            assignedIds = cardLabels.labels.map(function(l) { return l.maNhan; });
                        }

                        var html = '';
                        if (boardLabels.success && boardLabels.labels && boardLabels.labels.length > 0) {
                            boardLabels.labels.forEach(function(label) {
                                var isSelected = assignedIds.indexOf(label.maNhan) !== -1;
                                html += '<div class="label-item ' + (isSelected ? 'selected' : '') + '" data-label-id="' + label.maNhan + '" style="background-color: ' + label.maMau + '; display: flex; justify-content: space-between; align-items: center;">';
                                html += '<span>' + escapeHtml(label.tenHienThi) + '</span>';
                                if (isSelected) {
                                    html += '<i class="fa fa-check"></i>';
                                }
                                html += '</div>';
                            });
                        } else {
                            html = '<p class="text-muted">Chưa có nhãn nào. Tạo nhãn mới bên dưới.</p>';
                        }
                        $("#labelsList").html(html);
                    });
                });
            }

            // Toggle label cho thẻ
            $(document).on("click", ".label-item", function() {
                var cardId = $("#modalCardId").val();
                var labelId = $(this).data("label-id");
                var $this = $(this);

                $.post("/Board/ToggleCardLabel", { maThe: cardId, maNhan: labelId }, function(response) {
                    if (response && response.success) {
                        if (response.action === "added") {
                            $this.addClass("selected");
                            if ($this.find(".fa-check").length === 0) {
                                $this.append('<i class="fa fa-check"></i>');
                            }
                        } else {
                            $this.removeClass("selected");
                            $this.find(".fa-check").remove();
                        }
                        // Cập nhật hiển thị labels trên modal và thẻ
                        loadCardLabels(cardId);
                        refreshCardLabelsOnBoard(cardId);
                    }
                });
            });

            // Chọn màu cho label mới
            $(document).on("click", ".color-option", function() {
                $(".color-option").removeClass("selected");
                $(this).addClass("selected");
            });

            // Tạo label mới
            $("#btnCreateLabel").click(function() {
                var name = $("#newLabelName").val().trim();
                var color = $(".color-option.selected").data("color");

                if (!name) {
                    alert("Vui lòng nhập tên nhãn!");
                    return;
                }

                $.post("/Board/CreateLabel", { maBang: maBang, tenHienThi: name, maMau: color }, function(response) {
                    if (response && response.success) {
                        $("#newLabelName").val("");
                        var cardId = $("#modalCardId").val();
                        loadLabelsModal(cardId);
                    } else {
                        alert(response.message || "Không thể tạo nhãn");
                    }
                });
            });

            // Cập nhật labels trên thẻ trong board
            function refreshCardLabelsOnBoard(cardId) {
                $.get("/Board/GetCardLabels?maThe=" + cardId, function(response) {
                    if (response && response.success) {
                        var html = '';
                        if (response.labels && response.labels.length > 0) {
                            response.labels.forEach(function(label) {
                                html += '<span class="card-label" style="background-color: ' + label.maMau + ';" title="' + escapeHtml(label.tenHienThi) + '"></span>';
                            });
                        }
                        $("#cardLabels_" + cardId).html(html);
                    }
                });
            }

            // ========== MEMBERS FUNCTIONS ==========

            // Load members của thẻ hiện tại
            function loadCardMembers(cardId) {
                $.get("/Board/GetCardMembers?maThe=" + cardId, function(response) {
                    if (response && response.success) {
                        var html = '';
                        if (response.members && response.members.length > 0) {
                            response.members.forEach(function(member) {
                                var initials = getInitials(member.hoTen);
                                html += '<div class="d-flex align-items-center mr-2 mb-1" style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">';
                                html += '<span class="member-avatar mr-2" style="width: 24px; height: 24px; font-size: 10px;">' + initials + '</span>';
                                html += '<span class="small">' + escapeHtml(member.hoTen) + '</span>';
                                html += '</div>';
                            });
                        } else {
                            html = '<span class="text-muted small">Chưa có thành viên</span>';
                        }
                        $("#modalCardMembers").html(html);
                    }
                });
            }

            // Mở modal chọn members
            $("#btnShowMembers").click(function() {
                var cardId = $("#modalCardId").val();
                loadMembersModal(cardId);
                $("#membersModal").modal("show");
            });

            // Load danh sách members cho modal
            function loadMembersModal(cardId) {
                // Lấy tất cả thành viên của board
                $.get("/Board/GetAvailableMembers?maBang=" + maBang, function(availableMembers) {
                    // Lấy thành viên đã gán cho thẻ
                    $.get("/Board/GetCardMembers?maThe=" + cardId, function(cardMembers) {
                        var assignedIds = [];
                        if (cardMembers.success && cardMembers.members) {
                            assignedIds = cardMembers.members.map(function(m) { return m.maTaiKhoan; });
                        }

                        var html = '';
                        if (availableMembers.success && availableMembers.members && availableMembers.members.length > 0) {
                            availableMembers.members.forEach(function(member) {
                                var isSelected = assignedIds.indexOf(member.maTaiKhoan) !== -1;
                                var initials = getInitials(member.hoTen);
                                html += '<div class="member-item ' + (isSelected ? 'selected' : '') + '" data-member-id="' + member.maTaiKhoan + '">';
                                html += '<span class="member-avatar">' + initials + '</span>';
                                html += '<div class="member-info">';
                                html += '<div class="member-name">' + escapeHtml(member.hoTen) + '</div>';
                                html += '<div class="member-email">' + escapeHtml(member.email) + '</div>';
                                html += '</div>';
                                if (isSelected) {
                                    html += '<i class="fa fa-check text-primary"></i>';
                                }
                                html += '</div>';
                            });
                        } else {
                            html = '<p class="text-muted">Không có thành viên nào.</p>';
                        }
                        $("#membersList").html(html);
                    });
                });
            }

            // Toggle member cho thẻ
            $(document).on("click", ".member-item", function() {
                var cardId = $("#modalCardId").val();
                var memberId = $(this).data("member-id");
                var $this = $(this);

                $.post("/Board/ToggleCardMember", { maThe: cardId, maTaiKhoan: memberId }, function(response) {
                    if (response && response.success) {
                        if (response.action === "added") {
                            $this.addClass("selected");
                            if ($this.find(".fa-check").length === 0) {
                                $this.append('<i class="fa fa-check text-primary"></i>');
                            }
                        } else {
                            $this.removeClass("selected");
                            $this.find(".fa-check").remove();
                        }
                        // Cập nhật hiển thị members trên modal và thẻ
                        loadCardMembers(cardId);
                        refreshCardMembersOnBoard(cardId);
                    }
                });
            });

            // Cập nhật members trên thẻ trong board
            function refreshCardMembersOnBoard(cardId) {
                $.get("/Board/GetCardMembers?maThe=" + cardId, function(response) {
                    if (response && response.success) {
                        var html = '';
                        if (response.members && response.members.length > 0) {
                            response.members.forEach(function(member) {
                                var initials = getInitials(member.hoTen);
                                html += '<span class="card-member-avatar" title="' + escapeHtml(member.hoTen) + '">' + initials + '</span>';
                            });
                        }
                        $("#cardMembers_" + cardId).html(html);
                    }
                });
            }

            // ========== COMMENTS FUNCTIONS ==========

            function loadComments(cardId) {
                $.get("/Board/GetCardComments?maThe=" + cardId, function(response) {
                    if (response && response.success) {
                        var html = '';
                        if (response.comments && response.comments.length > 0) {
                            response.comments.forEach(function(comment) {
                                var initials = getInitials(comment.userName);
                                var timeStr = formatDateTime(comment.createdAt);
                                
                                html += '<div class="comment-item" data-comment-id="' + comment.id + '">';
                                html += '  <div class="comment-header">';
                                html += '    <div>';
                                html += '      <span class="comment-avatar">' + initials + '</span>';
                                html += '      <span class="comment-author">' + escapeHtml(comment.userName) + '</span>';
                                html += '    </div>';
                                if (canEdit) {
                                    html += '    <button class="comment-delete" onclick="deleteComment(' + comment.id + ')"><i class="fa fa-times"></i></button>';
                                }
                                html += '  </div>';
                                html += '  <div class="comment-time">' + timeStr + '</div>';
                                html += '  <div class="comment-content">' + escapeHtml(comment.content).replace(/\n/g, '<br>') + '</div>';
                                html += '</div>';
                            });
                        } else {
                            html = '<div class="no-comments">Chưa có bình luận nào</div>';
                        }
                        $("#commentsList").html(html);
                    }
                });
            }

            $("#btnAddComment").click(function() {
                var content = $("#commentInput").val().trim();
                var cardId = $("#modalCardId").val();
                
                if (!content) {
                    alert("Vui lòng nhập nội dung bình luận!");
                    return;
                }

                var btn = $(this);
                var originalText = btn.html();
                btn.prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> Đang gửi...');

                $.post("/Board/AddCardComment", { maThe: cardId, content: content })
                .done(function(response) {
                    if (response && response.success) {
                        $("#commentInput").val("");
                        loadComments(cardId);
                    } else {
                        alert(response.message || "Không thể thêm bình luận!");
                    }
                })
                .always(function() {
                    btn.prop("disabled", false).html(originalText);
                });
            });

            window.deleteComment = function(commentId) {
                if (!confirm("Xóa bình luận này?")) return;
                
                $.post("/Board/DeleteCardComment", { id: commentId }, function(response) {
                    if (response && response.success) {
                        var cardId = $("#modalCardId").val();
                        loadComments(cardId);
                    } else {
                        alert(response.message || "Không thể xóa bình luận!");
                    }
                });
            };

            // ========== HELPER FUNCTIONS ==========

            function getInitials(name) {
                if (!name) return "?";
                var parts = name.trim().split(" ");
                if (parts.length >= 2) {
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                }
                return name.substring(0, 2).toUpperCase();
            }

            function formatDateTime(dateStr) {
                if (!dateStr) return "";
                
                var date;
                if (typeof dateStr === 'string' && dateStr.indexOf('/Date(') === 0) {
                    var timestamp = parseInt(dateStr.substr(6));
                    date = new Date(timestamp);
                } else {
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) return "Không rõ thời gian";
                
                var now = new Date();
                var diffMs = now - date;
                var diffMins = Math.floor(diffMs / 60000);
                var diffHours = Math.floor(diffMs / 3600000);
                var diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return "Vừa xong";
                if (diffMins < 60) return diffMins + " phút trước";
                if (diffHours < 24) return diffHours + " giờ trước";
                if (diffDays < 7) return diffDays + " ngày trước";
                
                var day = ("0" + date.getDate()).slice(-2);
                var month = ("0" + (date.getMonth() + 1)).slice(-2);
                var year = date.getFullYear();
                var hours = ("0" + date.getHours()).slice(-2);
                var minutes = ("0" + date.getMinutes()).slice(-2);
                
                return hours + ":" + minutes + " " + day + "/" + month + "/" + year;
            }

            function escapeHtml(text) {
                if (!text) return "";
                var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }

            $("#commentInput").keypress(function(e) {
                if (e.which == 13 && !e.shiftKey) {
                    e.preventDefault();
                    $("#btnAddComment").click();
                }
            });

            // ========== SAVE & DELETE CARD ==========

            $("#btnSaveCard").click(function () {
                if (!canEdit) {
                    alert("Bạn não có quyền chỉnh sửa!");
                    return;
                }

                var cardId = $("#modalCardId").val();
                var title = $("#modalCardTitle").val().trim();
                var desc = $("#modalCardDesc").val().trim();
                var deadline = $("#modalCardDeadline").val();

                if (!title) {
                    alert("Vui lòng nhập tiêu đề thẻ!");
                    $("#modalCardTitle").focus();
                    return;
                }

                var btn = $(this);
                var originalText = btn.html();
                btn.prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> Đang lưu...');

                $.post("/Board/UpdateCardDetails", { id: cardId, title: title, desc: desc, deadline: deadline }, function (response) {
                    if (response && response.success) {
                        var card = $("#card_" + cardId);
                        card.find(".card-title").text(title);
                        
                        if (desc) {
                            if (card.find(".card-desc-icon").length === 0) {
                                card.find(".card-infos").prepend('<div class="card-desc-icon small text-muted"><i class="fa fa-align-left"></i></div>');
                            }
                        } else {
                            card.find(".card-desc-icon").remove();
                        }

                        if (deadline) {
                            var parts = deadline.split("-");
                            var displayDate = parts[2] + "/" + parts[1];
                            if (card.find(".card-deadline").length === 0) {
                                card.find(".card-infos").append('<div class="card-deadline small"><i class="fa fa-clock-o"></i> <span class="text-muted">' + displayDate + '</span></div>');
                            } else {
                                card.find(".card-deadline span").text(displayDate);
                            }
                        } else {
                            card.find(".card-deadline").remove();
                        }

                        $("#cardModal").modal("hide");
                        showNotification("Đã lưu thay đổi!", "success");
                    } else {
                        alert(response.message || "Không thể lưu thay đổi!");
                    }
                })
                .always(function() {
                    btn.prop("disabled", false).html(originalText);
                });
            });

            function showNotification(message, type) {
                var alertClass = type === "success" ? "alert-success" : "alert-danger";
                var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade show" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                    '<strong>' + message + '</strong>' +
                    '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                    '</div>');
                
                $("body").append(notification);
                setTimeout(function() { notification.fadeOut(function() { $(this).remove(); }); }, 3000);
            }

            $("#btnDeleteCard").click(function () {
                if (!canEdit) return;
                var cardId = $("#modalCardId").val();
                if (confirm("Xóa thẻ này?")) {
                    $.post("/Board/DeleteCard", { id: cardId }, function (r) {
                        if (r.success) {
                            var card = $("#card_" + cardId);
                            var columnId = card.closest(".card-list").attr("id").replace("col-", "");
                            card.remove();
                            updateColumnBadge(columnId);
                            $("#cardModal").modal("hide");
                        }
                    });
                }
            });
        });
    </script>
}